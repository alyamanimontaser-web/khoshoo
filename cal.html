<!DOCTYPE html>

<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ØªØ¯Ø±ÙŠØ¨ Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„ØµÙ„Ø§Ø© â€“ Ù…Ø¹Ø§ÙŠØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- TensorFlow + MediaPipe (Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø©) -->

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>

<style>
body{background:#020617;color:#fff;font-family:tahoma;text-align:center}
#container{position:relative;width:640px;margin:auto}
video,canvas{position:absolute;width:640px;height:480px;border-radius:12px}
button{padding:10px 16px;font-size:1rem;margin:6px}
#panel{margin-top:500px;font-size:1.1rem}
</style>

</head>
<body>

<h2>ğŸ•Œ ØªØ¯Ø±ÙŠØ¨ Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„ØµÙ„Ø§Ø© (Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)</h2>

<button id="btnStart">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button> <button id="btnTrain">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØµÙˆØªÙŠ</button>

<div id="container">
<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>
</div>

<div id="panel">
<div id="info">Ø§Ø¶ØºØ· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
</div>

<script>
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const info=document.getElementById('info');

let detector,currentKeypoints=null;

// ====== Ø±Ø³Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ø¸Ù…ÙŠ ======
const EDGES=[
 ['left_shoulder','right_shoulder'],['left_hip','right_hip'],
 ['left_shoulder','left_elbow'],['left_elbow','left_wrist'],
 ['right_shoulder','right_elbow'],['right_elbow','right_wrist'],
 ['left_hip','left_knee'],['left_knee','left_ankle'],
 ['right_hip','right_knee'],['right_knee','right_ankle'],
 ['left_shoulder','left_hip'],['right_shoulder','right_hip']
];

function drawSkeleton(kp){
 ctx.strokeStyle='#38bdf8';ctx.lineWidth=2;
 EDGES.forEach(([a,b])=>{
  const p1=kp.find(p=>p.name===a&&p.score>0.5);
  const p2=kp.find(p=>p.name===b&&p.score>0.5);
  if(p1&&p2){ctx.beginPath();ctx.moveTo(p1.x,p1.y);ctx.lineTo(p2.x,p2.y);ctx.stroke();}
 });
}

// ====== Ø­Ø³Ø§Ø¨Ø§Øª ======
function bodyHeight(kp){
 const v=kp.filter(p=>p.score>0.5).map(p=>p.y);
 return Math.max(...v)-Math.min(...v);
}

function angle(a,b,c){
 const ab={x:a.x-b.x,y:a.y-b.y};
 const cb={x:c.x-b.x,y:c.y-b.y};
 return Math.acos((ab.x*cb.x+ab.y*cb.y)/(Math.hypot(ab.x,ab.y)*Math.hypot(cb.x,cb.y)))*180/Math.PI;
}

// ====== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© ======
const calibration={camera:'front'};

// ====== ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ======
async function startCamera(){
 const stream=await navigator.mediaDevices.getUserMedia({video:true});
 video.srcObject=stream;await video.play();
 canvas.width=video.videoWidth;canvas.height=video.videoHeight;
 detector=await poseDetection.createDetector(
  poseDetection.SupportedModels.BlazePose,
  {runtime:'mediapipe',modelType:'lite',solutionPath:'https://cdn.jsdelivr.net/npm/@mediapipe/pose'}
 );
 info.innerText='Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ â€“ ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨';
 requestAnimationFrame(loop);
}

// ====== Ø­Ù„Ù‚Ø© Ø§Ù„Ø±ØµØ¯ ======
async function loop(){
 if(detector){
  const poses=await detector.estimatePoses(video);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(poses.length){
   currentKeypoints=poses[0].keypoints;
   drawSkeleton(currentKeypoints);
  }
 }
 requestAnimationFrame(loop);
}

// ====== ØªØ¯Ø±ÙŠØ¨ ØµÙˆØªÙŠ ======
function startTraining(){
 const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
 if(!SR){alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ');return;}
 const rec=new SR();rec.lang='ar-SA';rec.continuous=true;
 info.innerText='Ù‚Ù„: Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø± / Ø±ÙƒÙˆØ¹ / Ø³Ø¬ÙˆØ¯ / Ø¬Ù„ÙˆØ³';
 rec.onresult=e=>{
  const t=e.results[e.results.length-1][0].transcript.trim();
  if(!currentKeypoints)return;
  const g=n=>currentKeypoints.find(p=>p.name===n&&p.score>0.5);
  const hip=g('right_hip'),knee=g('right_knee'),ankle=g('right_ankle'),shoulder=g('right_shoulder');
  if(!hip||!knee||!ankle||!shoulder)return;
  const data={
   bodyHeight:bodyHeight(currentKeypoints),
   kneeAngle:angle(hip,knee,ankle),
   trunkAngle:angle(hip,shoulder,{x:hip.x,y:hip.y-100})
  };
  if(t.includes('Ø§Ù„Ù„Ù‡')){calibration.qiyam=data;info.innerText='ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ù…';}
  if(t.includes('Ø±ÙƒÙˆØ¹')){calibration.ruku=data;info.innerText='ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±ÙƒÙˆØ¹';}
  if(t.includes('Ø³Ø¬ÙˆØ¯')){calibration.sujood=data;info.innerText='ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬ÙˆØ¯';}
  if(t.includes('Ø¬Ù„ÙˆØ³')){calibration.juloos=data;info.innerText='ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„ÙˆØ³';}
  console.log('CALIBRATION',JSON.stringify(calibration,null,2));
 };
 rec.start();
}

// ====== Ø£Ø²Ø±Ø§Ø± ======
document.getElementById('btnStart').onclick=startCamera;
document.getElementById('btnTrain').onclick=startTraining;
</script>

</body>
</html>
