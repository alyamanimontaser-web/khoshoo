<!DOCTYPE html>

<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø±ØµØ¯ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø°ÙƒÙŠ â€“ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ÙŠØ¯ÙˆÙŠ</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>

<style>
body{background:#020617;color:white;font-family:tahoma;text-align:center}
#container{position:relative;width:640px;margin:auto}
video,canvas{position:absolute;width:640px;height:480px;border-radius:12px}
button{padding:8px 14px;font-size:1rem;margin:5px}
#panel{margin-top:500px;font-size:1.2rem}
</style>

</head>
<body>

<h2>ðŸ•Œ ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø³Ø¬ÙˆØ¯ ÙˆØ§Ù„Ø¬Ù„ÙˆØ³ (ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„ØµÙˆØª)</h2>

<button id="btnStart">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button> <button id="btnAutoTrain">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>

<div id="container">
<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>
</div>

<div id="panel">
<div id="info">Ø§Ø¶ØºØ· Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>
</div>
</div>

<script>
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const info=document.getElementById('info');

let detector,currentKeypoints=null;

const TRAIN={sujood:null,juloos:null};

function angle(a,b,c){
 const ab={x:a.x-b.x,y:a.y-b.y};
 const cb={x:c.x-b.x,y:c.y-b.y};
 const dot=ab.x*cb.x+ab.y*cb.y;
 const mag=Math.hypot(ab.x,ab.y)*Math.hypot(cb.x,cb.y);
 return Math.acos(dot/mag)*180/Math.PI;
}

function bodyHeight(kp){
 const v=kp.filter(p=>p.score>0.5);
 const ys=v.map(p=>p.y);
 return Math.max(...ys)-Math.min(...ys);
}

function extractFeatures(kp){
 const g=n=>kp.find(p=>p.name===n&&p.score>0.5);
 const hipL=g('left_hip'),hipR=g('right_hip');
 const kneeL=g('left_knee'),kneeR=g('right_knee');
 const ankleL=g('left_ankle'),ankleR=g('right_ankle');
 const shoulderL=g('left_shoulder'),shoulderR=g('right_shoulder');
 if(!hipL||!hipR||!kneeL||!kneeR||!ankleL||!ankleR||!shoulderL||!shoulderR) return null;
 const hip={x:(hipL.x+hipR.x)/2,y:(hipL.y+hipR.y)/2};
 const knee={x:(kneeL.x+kneeR.x)/2,y:(kneeL.y+kneeR.y)/2};
 const ankle={x:(ankleL.x+ankleR.x)/2,y:(ankleL.y+ankleR.y)/2};
 const shoulder={x:(shoulderL.x+shoulderR.x)/2,y:(shoulderL.y+shoulderR.y)/2};
 return {
  bodyHeight: bodyHeight(kp),
  kneeAngle: angle(hip,knee,ankle),
  trunkAngle: angle(shoulder,hip,knee)
 };
}

async function startCamera(){
 const stream=await navigator.mediaDevices.getUserMedia({video:true});
 video.srcObject=stream;
 await video.play();
 canvas.width=video.videoWidth;
 canvas.height=video.videoHeight;
 detector=await poseDetection.createDetector(
  poseDetection.SupportedModels.BlazePose,
  {runtime:'mediapipe',modelType:'lite',solutionPath:'https://cdn.jsdelivr.net/npm/@mediapipe/pose'}
 );
 requestAnimationFrame(loop);
}

async function loop(){
 const poses=await detector.estimatePoses(video);
 ctx.clearRect(0,0,canvas.width,canvas.height);
 if(poses.length) currentKeypoints=poses[0].keypoints;
 requestAnimationFrame(loop);
}

document.getElementById('trainSujood').onclick=()=>{
 if(!currentKeypoints) return;
 TRAIN.sujood=extractFeatures(currentKeypoints);
 info.innerText='ØªÙ… ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø³Ø¬ÙˆØ¯';
 console.log('SUJOOD',TRAIN.sujood);
};

document.getElementById('trainJuloos').onclick=()=>{
 if(!currentKeypoints) return;
 TRAIN.juloos=extractFeatures(currentKeypoints);
 info.innerText='ØªÙ… ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¬Ù„ÙˆØ³';
 console.log('JULOOS',TRAIN.juloos);
};

document.getElementById('btnStart').onclick=startCamera;
</script>

</body>
</html>
