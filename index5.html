<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<title>رصد وضعيات الصلاة – نسخة مستقرة</title>
<style>
  body { font-family: Arial; text-align: center; background:#f5f5f5 }
  video, canvas { position: absolute; left: 50%; transform: translateX(-50%) scaleX(-1); }
  video { width: 640px; height: 480px; }
  canvas { width: 640px; height: 480px; pointer-events:none }
  #controls { margin-top: 520px }
</style>
</head>
<body>
<h2>تطبيق رصد وضعيات الصلاة</h2>
<div>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
</div>
<div id="controls">
  <button id="startBtn">ابدأ</button>
  <p id="status">في الانتظار…</p>
</div>

<!-- الأصوات -->
<audio id="takbir" src="takbir.mp3"></audio>
<audio id="qiyam" src="qiyam.mp3"></audio>
<audio id="ruku" src="ruku.mp3"></audio>
<audio id="sujood" src="sujood.mp3"></audio>
<audio id="juloos" src="juloos.mp3"></audio>

<script type="module">
// ===== IMPORTS (ESM – الحل النهائي لمشكلة MIME) =====
import * as tf from "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.12.0";
import "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-cpu@4.12.0";
import * as poseDetection from "https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.3";

// ===== ELEMENTS =====
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');

// ===== AUDIO =====
const sounds = {
  qiyam: document.getElementById('qiyam'),
  ruku: document.getElementById('ruku'),
  sujood: document.getElementById('sujood'),
  juloos: document.getElementById('juloos'),
};

let detector;
let maxHeight = 0;
let lastPose = '';
let lastTime = 0;

// ===== START =====
document.getElementById('startBtn').onclick = startApp;

async function startApp() {
  statusEl.textContent = 'تشغيل الكاميرا…';

  await tf.setBackend('cpu');
  await tf.ready();

  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;

  detector = await poseDetection.createDetector(
    poseDetection.SupportedModels.BlazePose,
    { runtime: 'mediapipe', modelType: 'lite', solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/pose' }
  );

  statusEl.textContent = 'جارٍ الرصد…';
  requestAnimationFrame(loop);
}

// ===== UTILS =====
function bodyHeight(kp) {
  const v = kp.filter(p => p.score > 0.5);
  if (v.length < 5) return 0;
  const ys = v.map(p => p.y);
  return Math.max(...ys) - Math.min(...ys);
}

function angle(a,b,c) {
  const ab={x:a.x-b.x,y:a.y-b.y};
  const cb={x:c.x-b.x,y:c.y-b.y};
  const dot=ab.x*cb.x+ab.y*cb.y;
  const mag=Math.hypot(ab.x,ab.y)*Math.hypot(cb.x,cb.y);
  return Math.acos(dot/mag)*180/Math.PI;
}

function detectPose(kp) {
  const g=n=>kp.find(p=>p.name===n&&p.score>0.5);
  const hip=g('right_hip'), knee=g('right_knee'), ankle=g('right_ankle');
  if(!hip||!knee||!ankle) return null;

  const h = bodyHeight(kp);
  if (h > maxHeight) maxHeight = h;
  if (!maxHeight) return null;

  const ratio = h / maxHeight;
  const k = angle(hip,knee,ankle);

  if (ratio < 0.45) return 'sujood';
  if (ratio < 0.65 && k < 130) return 'juloos';
  if (ratio < 0.85) return 'ruku';
  if (k > 160) return 'qiyam';
  return null;
}

function drawSkeleton(kp) {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  kp.forEach(p=>{
    if(p.score>0.5){
      ctx.beginPath();
      ctx.arc(p.x,p.y,4,0,2*Math.PI);
      ctx.fill();
    }
  });
}

// ===== LOOP =====
async function loop() {
  const poses = await detector.estimatePoses(video);
  if (poses.length) {
    const kp = poses[0].keypoints;
    drawSkeleton(kp);

    const pose = detectPose(kp);
    if (pose && pose !== lastPose && performance.now() - lastTime > 600) {
      sounds[pose]?.play();
      statusEl.textContent = pose;
      lastPose = pose;
      lastTime = performance.now();
    }
  }
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
