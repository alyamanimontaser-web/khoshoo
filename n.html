<!DOCTYPE html>

<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø±ØµØ¯ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø°ÙƒÙŠ â€“ Ù…Ø¹Ø§ÙŠØ±Ø© Ù…Ø¯Ù…Ø¬Ø©</title>

  <!-- TensorFlow + MediaPipe (Ø¥ØµØ¯Ø§Ø±Ø§Øª Ù…Ø³ØªÙ‚Ø±Ø©) -->

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>

  <style>
    body{background:#020617;color:white;font-family:tahoma;text-align:center}
    #container{position:relative;width:640px;margin:auto}
    video,canvas{position:absolute;width:640px;height:480px;border-radius:12px}
    button,select{padding:8px 14px;font-size:1rem;margin:5px}
    #panel{margin-top:500px;font-size:1.2rem}
    #confidenceBar{width:300px;height:16px;background:#334155;margin:10px auto;border-radius:10px}
    #confidenceFill{height:100%;width:0%;background:#22c55e}
  </style>

</head>
<body>

<h2>ğŸ•Œ Ø±ØµØ¯ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø°ÙƒÙŠ (Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©)</h2>

<button id="btnStart">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹</button>

<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
</div>

<div id="panel">
  <div id="info">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± â€“ Ù‚Ù„: Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±</div>
  <div id="confidenceBar"><div id="confidenceFill"></div></div>
</div>

<!-- Ø§Ù„Ø£ØµÙˆØ§Øª -->

<audio id="takbir" src="takbir.mp3"></audio> <audio id="qiyam" src="qiyam.mp3"></audio> <audio id="ruku" src="ruku.mp3"></audio> <audio id="sujood" src="sujood.mp3"></audio> <audio id="juloos" src="juloos.mp3"></audio>

<script>
// ================= Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© =================
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const info=document.getElementById('info');
const confidenceFill=document.getElementById('confidenceFill');

let detector,lastPose='',lastTime=0;
let stablePose='',stableSince=0;
let prayerStarted=false;

const sounds={takbir,qiyam,ruku,sujood,juloos};

// ================= Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© (Ù…Ù† Ù…Ù„ÙÙƒ) =================
const CALIBRATION={
  camera:'front',
  sujood:{bodyHeight:134.56,kneeAngle:37.09,trunkAngle:3.65},
  juloos:{bodyHeight:206.24,kneeAngle:168.42,trunkAngle:169.31}
};

// ================= Ø£Ø¯ÙˆØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ© =================
function angle(a,b,c){
  const ab={x:a.x-b.x,y:a.y-b.y};
  const cb={x:c.x-b.x,y:c.y-b.y};
  const dot=ab.x*cb.x+ab.y*cb.y;
  const mag=Math.hypot(ab.x,ab.y)*Math.hypot(cb.x,cb.y);
  return Math.acos(dot/mag)*180/Math.PI;
}

function bodyHeight(kp){
  const v=kp.filter(p=>p.score>0.5);
  const ys=v.map(p=>p.y);
  return Math.max(...ys)-Math.min(...ys);
}

// ================= ÙƒØ´Ù Ø§Ù„ÙˆØ¶Ø¹ÙŠØ© (Ù…ÙØ¯Ù…Ø¬ Ø¨Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©) =================
function detectPose(kp){
  const g=n=>kp.find(p=>p.name===n&&p.score>0.5);
  const hipL=g('left_hip'),hipR=g('right_hip');
  const kneeL=g('left_knee'),kneeR=g('right_knee');
  const ankleL=g('left_ankle'),ankleR=g('right_ankle');
  const shoulderL=g('left_shoulder'),shoulderR=g('right_shoulder');

  if(!hipL||!hipR||!kneeL||!kneeR||!ankleL||!ankleR||!shoulderL||!shoulderR)
    return {pose:'unknown',conf:0.2};

  const hip={x:(hipL.x+hipR.x)/2,y:(hipL.y+hipR.y)/2};
  const knee={x:(kneeL.x+kneeR.x)/2,y:(kneeL.y+kneeR.y)/2};
  const ankle={x:(ankleL.x+ankleR.x)/2,y:(ankleL.y+ankleR.y)/2};
  const shoulder={x:(shoulderL.x+shoulderR.x)/2,y:(shoulderL.y+shoulderR.y)/2};

  const h=bodyHeight(kp);
  const kneeAngle=angle(hip,knee,ankle);
  const trunkAngle=angle(shoulder,hip,knee);

  if(Math.abs(h-CALIBRATION.sujood.bodyHeight)<30 && kneeAngle<70)
    return {pose:'sujood',conf:0.98};

  if(Math.abs(h-CALIBRATION.juloos.bodyHeight)<35 && kneeAngle>140)
    return {pose:'juloos',conf:0.95};

  if(trunkAngle<120)
    return {pose:'ruku',conf:0.9};

  if(kneeAngle>160 && h>CALIBRATION.juloos.bodyHeight*1.2)
    return {pose:'qiyam',conf:0.9};

  return {pose:'unknown',conf:0.3};
}

// ================= Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ =================
async function startCamera(){
  const stream=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=stream;
  await video.play();
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;

  detector=await poseDetection.createDetector(
    poseDetection.SupportedModels.BlazePose,
    {runtime:'mediapipe',modelType:'lite',solutionPath:'https://cdn.jsdelivr.net/npm/@mediapipe/pose'}
  );
}

// ================= Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªÙƒØ¨ÙŠØ± =================
function startListening(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){info.innerText='Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ';return;}
  const rec=new SR();
  rec.lang='ar-SA';rec.continuous=true;
  rec.onresult=e=>{
    const t=e.results[e.results.length-1][0].transcript;
    if(t.includes('Ø§Ù„Ù„Ù‡')){
      prayerStarted=true;
      sounds.takbir.play();
      info.innerText='Ø¨Ø¯Ø£Øª Ø§Ù„ØµÙ„Ø§Ø©';
      rec.stop();
      requestAnimationFrame(loop);
    }
  };
  rec.start();
}

// ================= Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =================
async function loop(t){
  if(!prayerStarted){requestAnimationFrame(loop);return;}
  if(t-lastTime<120){requestAnimationFrame(loop);return;}
  lastTime=t;

  const poses=await detector.estimatePoses(video);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(poses.length){
    const res=detectPose(poses[0].keypoints);
    confidenceFill.style.width=`${res.conf*100}%`;
    if(res.pose!==lastPose && sounds[res.pose]){
      sounds[res.pose].play();
      lastPose=res.pose;
    }
    info.innerText=`Ø§Ù„ÙˆØ¶Ø¹ÙŠØ©: ${res.pose}`;
  }
  requestAnimationFrame(loop);
}

// ================= Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =================
document.getElementById('btnStart').onclick=async()=>{
  await startCamera();
  startListening();
};
</script>

</body>
</html>
