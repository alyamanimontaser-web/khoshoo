<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ Ù…ØªÙ‚Ø¯Ù… Ù„Ø±ØµØ¯ Ø§Ù„ØµÙ„Ø§Ø©</title>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.12.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.12.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.12.0"></script>

  <!-- Pose Detection + MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>

  <style>
    body { margin:0; font-family:Tahoma; background:#020617; color:white; text-align:center; }
    h2 { margin:10px; }
    #container { position:relative; width:640px; margin:auto; }
    video, canvas { width:640px; height:480px; position:absolute; border-radius:12px; }
    video { z-index:1; }
    canvas { z-index:2; }
    button { padding:10px 20px; font-size:1rem; border-radius:10px; border:none; cursor:pointer; }
    #panel { margin-top:500px; font-size:1.2rem; }
    #confidenceBar { width:300px; height:18px; background:#334155; margin:10px auto; border-radius:10px; overflow:hidden; }
    #confidenceFill { height:100%; width:0%; background:#22c55e; }
  </style>
</head>
<body>

<h2>ğŸ•Œ Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ Ù…ØªÙ‚Ø¯Ù… Ù„Ø±ØµØ¯ Ø§Ù„ØµÙ„Ø§Ø©</h2>
<button onclick="startApp()">Ø§Ø¨Ø¯Ø£</button>

<div id="container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
</div>

<div id="panel">
  <div id="info">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</div>
  <div id="confidenceBar"><div id="confidenceFill"></div></div>
</div>

<audio id="qiyam" src="qiyam.mp3"></audio>
<audio id="ruku" src="ruku.mp3"></audio>
<audio id="sujood" src="sujood.mp3"></audio>
<audio id="juloos" src="juloos.mp3"></audio>
<audio id="tashahhud" src="tashahhud.mp3"></audio>
<audio id="tasleem" src="tasleem.mp3"></audio>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const info = document.getElementById('info');
const confidenceFill = document.getElementById('confidenceFill');

let detector, lastPose='', inSujood=false;
let sujoodCount=0, rakahCount=0;
let poseHistory=[], lastAnalysisTime=0;

const sounds={
  qiyam, ruku, sujood, juloos,
  tashahhud, tasleem
};

const EDGES=[
 ['right_shoulder','right_elbow'],['right_elbow','right_wrist'],
 ['right_hip','right_knee'],['right_knee','right_ankle'],
 ['right_shoulder','right_hip'],['right_shoulder','nose']
];

function playSound(p){ if(p!==lastPose && sounds[p]){ sounds[p].currentTime=0; sounds[p].play(); lastPose=p; }}

function angle(a,b,c){ const ab={x:a.x-b.x,y:a.y-b.y}; const cb={x:c.x-b.x,y:c.y-b.y}; return Math.acos((ab.x*cb.x+ab.y*cb.y)/(Math.hypot(ab.x,ab.y)*Math.hypot(cb.x,cb.y)))*180/Math.PI; }

function detectPose(kp){
  const g=n=>kp.find(p=>p.name===n && p.score>0.5);
  const hip=g('right_hip'), knee=g('right_knee'), ankle=g('right_ankle'), shoulder=g('right_shoulder'), nose=g('nose');
  if(!hip||!knee||!ankle||!shoulder||!nose) return {pose:'unknown', conf:0};

  const kneeA=angle(hip,knee,ankle);
  const torsoA=angle(hip,shoulder,{x:shoulder.x,y:shoulder.y-100});
  const head=Math.abs(nose.y-hip.y);

  if(kneeA>165 && torsoA>155) return {pose:'qiyam', conf:0.9};
  if(kneeA>165 && torsoA<125) return {pose:'ruku', conf:0.9};
  if(kneeA<95 && head<60) return {pose:'sujood', conf:1.0};
  if(kneeA<125 && torsoA>145) return {pose:'juloos', conf:0.8};
  if(kneeA<125 && torsoA>160) return {pose:'tashahhud', conf:0.8};
  return {pose:'unknown', conf:0.3};
}

function drawSkeleton(kp){
  ctx.strokeStyle='#38bdf8'; ctx.lineWidth=2;
  EDGES.forEach(([a,b])=>{
    const p1=kp.find(p=>p.name===a&&p.score>0.5);
    const p2=kp.find(p=>p.name===b&&p.score>0.5);
    if(p1&&p2){ ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke(); }
  });
}

async function startApp(){
  const stream=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=stream;
  await new Promise(r=>video.onloadedmetadata=r);
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;

  detector=await poseDetection.createDetector(
    poseDetection.SupportedModels.BlazePose,
    { runtime:'mediapipe', modelType:'lite', solutionPath:'https://cdn.jsdelivr.net/npm/@mediapipe/pose' }
  );
  info.innerText='ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ â€“ ÙŠØªÙ… Ø§Ù„Ø±ØµØ¯ Ø§Ù„Ø¢Ù†';
  requestAnimationFrame(loop);
}

async function loop(t){
  if(t-lastAnalysisTime<120){ requestAnimationFrame(loop); return; }
  lastAnalysisTime=t;

  const poses=await detector.estimatePoses(video);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(poses.length){
    const kp=poses[0].keypoints;
    drawSkeleton(kp);

    const {pose, conf}=detectPose(kp);
    poseHistory.push(pose); if(poseHistory.length>5) poseHistory.shift();
    const stable=poseHistory.every(p=>p===pose)?pose:'unknown';

    confidenceFill.style.width=`${Math.round(conf*100)}%`;
    playSound(stable);

    if(stable==='sujood'&&!inSujood){ sujoodCount++; inSujood=true; if(sujoodCount===2){ rakahCount++; sujoodCount=0; }}
    if(stable!=='sujood') inSujood=false;

    info.innerText=`Ø§Ù„ÙˆØ¶Ø¹ÙŠØ©: ${stable} | Ø§Ù„Ø±ÙƒØ¹Ø§Øª: ${rakahCount}`;
  }
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
